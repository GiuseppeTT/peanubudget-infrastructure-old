name: Check Terraform plan

on:
  pull_request:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          cli_config_credentials_hostname: app.terraform.io
          cli_config_credentials_token: ${{ secrets.TF_TOKEN }}
          terraform_version: ~1.3

      - name: Format Terraform files (dry run) (only for checking)
        id: fmt
        run: terraform fmt -check
        continue-on-error: true

      - name: Initialize Terraform
        id: init
        run: terraform init

      - name: Lint Terraform files
        id: validate
        run: terraform validate -no-color

      - name: Generate terraform plan
        id: plan
        run: terraform plan -no-color -input=false

      - name: Generate summary
        env:
          PLAN: "${{ steps.plan.outputs.stdout }}"
        run: |
          summary="\n
          #### Terraform Format and Style ğŸ–Œ \`${{ steps.fmt.outcome }}\`\n\n

          #### Terraform Initialization âš™ï¸ \`${{ steps.init.outcome }}\`\n\n

          #### Terraform Validation ğŸ¤– \`${{ steps.validate.outcome }}\`\n\n

          #### Terraform Plan ğŸ“– \`${{ steps.plan.outcome }}\`\n
          <details>\n
          <summary>Show Plan</summary>\n
          \`\`\`\n
          ${process.env.PLAN}\n
          \`\`\`\n
          </details>
          "

          echo -e ${summary} >> $GITHUB_STEP_SUMMARY
